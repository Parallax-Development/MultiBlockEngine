name: Publish Release

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build
        run: ./gradlew clean build -x test
        env:
          RELEASE_VERSION: ${{ github.event.release.tag_name }}

      - name: Select release JAR
        id: jar
        shell: bash
        run: |
          set -euo pipefail
          echo "Listing build/libs"
          ls -lah build/libs || true

          mapfile -t jars < <(
            find build/libs -maxdepth 1 -type f -name "*.jar" \
              ! -name "*-sources.jar" \
              ! -name "*-javadoc.jar" \
              -print | sort
          )

          if [ "${#jars[@]}" -ne 1 ]; then
            echo "Expected exactly 1 release jar in build/libs, found ${#jars[@]}" >&2
            printf '%s\n' "${jars[@]}" >&2
            exit 1
          fi

          test -f "${jars[0]}"
          echo "Selected jar: ${jars[0]}"
          echo "path=${jars[0]}" >> "$GITHUB_OUTPUT"


      - name: Upload JAR to GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.release.tag_name }}
          fail_on_unmatched_files: true
          files: ${{ steps.jar.outputs.path }}

      - name: Publish
        run: ./gradlew publish
        env:
          RELEASE_VERSION: ${{ github.event.release.tag_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

